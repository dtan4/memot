#!/usr/bin/env ruby

require "memot"
require "yaml"

config_dir = ENV["MEMOT_CONFIG_DIR"] || ENV["HOME"]
config_path = File.join(config_dir, ".memot.yml")

unless File.exists? config_path
  $stderr.puts "#{config_path} is not found"
  exit 1
end

config = YAML.load_file(config_path)
auth = config["auth"] || {}

if ARGV.shift == "--auth"
  access_token = Memot::DropboxCli.auth(auth["dropbox"]["app_key"], auth["dropbox"]["app_secret"])
  puts access_token
  exit 0
end

notes = config["notes"] || {}

redis_host = ENV["REDIS_PORT_6379_TCP_ADDR"] || "127.0.0.1"
redis_port = (ENV["REDIS_PORT_6379_TCP_PORT"] || "6379").to_i

redis = Redis.new(host: redis_host, port: redis_port, driver: :hiredis)
logger = Logger.new($stdout)

dropbox = Memot::DropboxCli.new(auth["dropbox"]["access_token"].to_s, redis)
evernote = Memot::EvernoteCli.new(auth["evernote"]["token"], auth["evernote"]["sandbox"], logger)
cli = Memot::Client.new(dropbox, evernote, logger)

cli.update(notes)
